# 7 USER AUTHENTICATION

## 7.0 Create Account part One

ê³„ì • ìƒì„± í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë³´ì

ì´ì „ì— í–ˆë˜ê±¸ í•˜ë©´ ì¸ì¦ë¶€ë¶„ì„ ì¶”ê°€í• êº¼ì„

`User.js`

```js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  name: { type: String, required: true },
  location: String,
});

const User = mongoose.model("User", userSchema);
export default User;
```

`init.js`

```js
import "./db";
import "./models/Video";
import "./models/User"; // User ì¶”ê°€
import app from "./server";

const PORT = 4000;

const handleListening = () =>
  console.log(`âœ… Server listenting on port http://localhost:${PORT} ğŸš€`);

app.listen(PORT, handleListening);
```

`userController.js`

```js
export const join = (req, res) =>
  res.render("createAccount", { pageTitle: "Create Account" });
```

`join.pug`

```pug
extends base


block content
    form(method="post")
        input(name="name" type="text" required placeholder="name")
        input(name="email" type="email" required placeholder="email")
        input(name="username" type="text" required placeholder="username")
        input(name="password" type="password" required placeholder="passoword")
        input(name="location" type="text" placeholder="location")
        input(type="submit", value="Join")
```

## 7.1 Create Account part Two

ì˜ìƒ ë³´ê¸° ê·€ì°®ë‹¤ ê± ë‚´ê°€ í˜¼ì ë§Œë“¤ê³  ë‚˜ì„œ ì˜ìƒ ë³´ì

```js
import User from "../models/User";

export const postJoin = async (req, res) => {
  const { name, email, username, password, location } = req.body;

  try {
    await User.create({
      name,
      email,
      username,
      password,
      location,
    });
    return res.redirect("/login");
  } catch (error) {
    console.log(error);
    res.render("join", { pageTitle: "Join" });
  }
};
```

```shell
> db.users.find()
{ "_id" : ObjectId("6224b00cc5e0db439b49d8b0"), "email" : "dlddl@123", "username" : "ì•ˆì•ˆë…•", "password" : "1231", "name" : "ì•ˆë…•", "location" : "ëª°ë¼", "__v" : 0 }
```

í¬ íŒŒì›Œì…€ë¡œ db í™•ì¸í•´ë³´ë‹ˆê¹Œ ì˜ìˆìŒ ã…‹ ê°œì©œ ã…‹

ã…ˆë°¥ì´ì§€ ã…‹

ê·¼ë° "\_\_v" ì´ê±´ ë­ëƒ

ì•”íŠ¼ ì˜ìƒì´ë‚˜ ë³´ëŸ¬ê°€ì

ë‹ˆì½”ë„ ë˜‘ê°™ì´ í•¨ ê·¼ë° try catch ì•ˆí•¨

ê·¼ë° ë³´ë©´ `password`ê°€ ê·¸ëŒ€ë¡œ ë…¸ì¶œë¨

ì´ëŸ¬ë©´ ë³´ì•ˆì´ ì „í˜€ ì•ˆë˜ê² ì§€?

ê·¸ë˜ì„œ `password`ë¥¼ ì €ì¥í•˜ê¸°ì „ì— ë³´ì•ˆì²˜ë¦¬ë¥¼ í•´ì•¼í•¨

ê·¸ê±¸ `í•´ì‹±`ì´ë¼ê³  ë¶€ë¦„

## 7.2 Creating Account part Three

DBì— passwordë¥¼ ì €ì¥í•˜ì§€ ì•Šê³  í•´ì‹±ëœ passwordë¥¼ ì €ì¥í• êº¼ì„

í•´ì‹±ì€ ì¼ë°©í–¥ í•¨ìˆ˜ì„

`bcrypt` ë¥¼ ì“¸êº¼ì„

```
npm i bcrypt
```

```js
bcrypt.hash(myPlaintextPassword, saltRounds, function (err, hash) {
  // Store hash in your password DB.
});
```

ìš”ê±¸ ì“¸êº¼ì„

`User.js`

```js
import bcrypt from "bcrypt";

userSchema.pre("save", async function () {
  this.password = await bcrypt.hash(this.password, 5);
});
```

ì´ëŸ¬ë©´ ëœë‹¤~

```
> db.users.find()
{ "_id" : ObjectId("6225a7591ab7dfae733de126"), "email" : "dlddl@123", "username" : "ì•ˆì•ˆë…•", "password" : "$2b$05$Htn0FUwR/TePrNczG1hXq.bh/Jqn695xjnVg0iY2zjv2JKB5VphEG", "name" : "ì•ˆë…•", "location" : "ëª°ë¼", "__v" : 0 }
```

ì•„ì£¼ ë§›ìˆê²Œ í•´ì‹œëë‹¤~

## 7.3 Form Validation

ì´ë²ˆì—ëŠ” join ì¤‘ë³µ ì²˜ë¦¬ í•´ë³´ì

```js
import User from "../models/User";

export const getJoin = (req, res) => res.render("join", { pageTitle: "Join" });
export const postJoin = async (req, res) => {
  const { name, username, email, password, password2, location } = req.body;
  const pageTitle = "Join";
  if (password !== password2) {
    return res.render("join", {
      pageTitle,
      errorMessage: "Password confirmation does not match.",
    });
  }

  const exists = await User.exists({ $or: [{ username }, { email }] });
  if (exists) {
    return res.render("join", {
      pageTitle,
      errorMessage: "This username/email is already taken.",
    });
  }

  await User.create({
    name,
    username,
    email,
    password,
    location,
  });
  return res.redirect("/login");
};
```

ì•„ ê·¼ë° ë‚˜ í˜¼ì í• ë• ê± trycatch ë¡œ í•˜ê³  error ë³€ìˆ˜ ê± ì¶œë ¥ì‹œí‚¤ëŠ”ê±¸ë¡œ ëëƒˆëŠ”ë° ì´ê²Œ ì‚¬ìš©ìë“¤ì´ ë³´ê¸°ì—ëŠ” ë” ë§ëŠ”ë“¯

ì•„ë‹ˆê·¼ë° ì™œ ë‹ˆì½” ìê¾¸ trycatch ì•ˆì¨

ê·¸ë¦¬ê³  ê·¼ë° ì´ê±° ê°œë³„ë¡œì•¼

ë¹„ë™ê¸°í™”ë¡œ ì¡°ì ¸ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ”ì§€ í™•ì¸í•´ì¤˜ì•¼ì§€

ë‚˜ì¤‘ì— ë°”ê¿”ì¤„ë“¯

ê·¸ë³´ë‹¤

```js
const exists = await User.exists({ $or: [{ username }, { email }] });
```

ì—¬ê¸°ì„œ

`$or`

    $or ì—°ì‚°ìëŠ” ë‘˜ ì´ìƒì˜ ì¡°ê±´ì— ëŒ€í•´ ë…¼ë¦¬ì  OR ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê³  ì¡°ê±´ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì¶©ì¡±í•˜ëŠ” ë¬¸ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.

ex)

```js
db.inventory.find({ $or: [{ quantity: { $lt: 20 } }, { price: 10 }] });
```

[ì°¸ê³ ë§í¬](https://docs.mongodb.com/manual/reference/operator/query/or/#mongodb-query-op.-or)

## 7.4 Status Codes

ë¸Œë¼ìš°ì €ì—ì„œ ì¡°ì¸ì„ í•˜ë©´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëœ¨ëŠ”ë°

ê·¼ë° ë‚´ê°€ íšŒì›ê°€ì…ì„ ì‹¤íŒ¨í•´ë„ ê·¸ê²Œ ëœ¸

ë¸Œë¼ìš°ì €ëŠ” ë­˜ ì•ˆë‹¤ê³  íŒ¨ìŠ¤ì›Œë“œ ì €ì¥ë€ì´ ëœ¨ëŠ” ê±¸ê¹Œ?

ë°”ë¡œ `status Codes` ë¥¼ ë³´ê³  ì–˜ê¸°ë¥¼ í•˜ëŠ” ê±°ì„

ìƒíƒœì½”ë“œë¼ê³  ì´ê±°ìŠ¨ ëª¨ì‹œëƒ

```
POST /join 200 280.558 ms - 774
```

ì´ê±°ì„

post ëŠ” form ë°©ì‹ì´ê³  joinì€ ì£¼ì†Œê³  ê·¸ëŸ¼ 200ì€ ë­˜ê¹Œ

ìœ„í‚¤í”¼ë””ì•„ì— ìƒíƒœì½”ë“œ 200ì„ ì¹˜ë©´ `OK` ë˜

ê·¸ë‹ˆê¹Œ ìƒíƒœì½”ë“œ 200 ì‘ë‹µì„ ë°›ì•˜ê¸°ì—
ì„±ê³µí–ˆë‹¤ê³  ë³´ê³  ì €ì¥í• ë ¤ê³  í•œê±°ì„

ì´ê±¸ ë°”ê¾¸ì

```js
if (exists) {
  return res.status(400).render("join", {
    pageTitle,
    errorMessage: "This username/email is already taken.",
  });
}
```

ì´ë ‡ê²Œ í•˜ë©´ ìƒíƒœì½”ë“œ `400`(Bad Request) ë¡œ ì˜ê²Œ ë¨

ë°±ë‚  ì˜¬ë°”ë¥´ì§€ ì•Šì€ í˜ì´ì§€ë‹ˆ ë­ë‹ˆ String ê°’ì„ ë³´ë‚´ë„

ë¸Œë¼ìš°ì €ëŠ” ëª¨ë¦„

HTTP Status code ë¥¼ ì¨ì•¼ ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ë¨¹ìŒ

## 7.5 Login part One

ë¡œê·¸ì¸ íŒŒíŠ¸ë¥¼ í• êº¼ì„

```js
export const getLogin = (req, res) => {
  return res.render("login", { pageTitle: "Login" });
};
export const postLogin = async (req, res) => {
  const { username, password } = req.body;

  const exists = await User.exists({ username });
  if (!exists) {
    return res.status(400).render("login", {
      pageTitle: "Login",
      errorMessage: "An account with this username does not exists.",
    });
  }

  return res.end();
};
```

## 7.6 Login part Two

ì´ì œ passwordê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì„ êµ¬í˜„í•˜ì

í•œë²ˆ ì˜ˆìƒí•´ë³´ë©´

ì´ìš©ìê°€ ì…ë ¥í•œ password ê°’ì„ í•´ì‹±í•˜ì—¬

DB password ê°’ê³¼ ë¹„êµí•´ì„œ í•´ì‹±í•œ ë‘ê°œì˜ ê°’ì´ ê°™ìœ¼ë©´

ë¡œê·¸ì¸ì´ ë˜ê²Œ í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?

í•œë²ˆ ì˜ìƒì„ ë³´ì

ã…‡ã…‡ ë§ˆì¦˜

ê·¼ë° ë‹¨ìˆœíˆ if ì ˆë¡œ êµ¬í˜„í•˜ëŠ”ê²Œ ì•„ë‹Œ

`bcrypt.compare` ì„ ì“¸êº¼ì„ ìš”ê±¸ ì“°ë©´ `true`, `false` ë¥¼ ë°˜í™˜í• êº¼ì„

```js
export const postLogin = async (req, res) => {
  const { username, password } = req.body;
  const pageTitle = "Login";
  const user = await User.findOne({ username });
  if (!user) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "An account with this username does not exists.",
    });
  }
  const ok = await bcrypt.compare(password, user.password);
  if (!ok) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "Wrong password",
    });
  }
  return res.redirect("/");
};
```

```js
const exists = await User.exists({ username });
```

ìš”ê±° ì»ì—ˆëŠ”ë°

í•´ë‹¹ user ì •ë³´ê°’ì„ ì§ì ‘ ë°›ê¸° ë•Œë¬¸ì—

```js
const user = await User.findOne({ username });
if (!user) {
  // ~~~~
}
```

ì´ê±¸ë¡œ ëŒ€ì²´í•¨
