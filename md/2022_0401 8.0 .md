# 8 USER PROFILE

## 8.0 Edit Profile GET

이제 edit profile 페이지를 만들어 보자

```js
export const getEdit = (req, res) => {
  return res.render("edit-profile", { pageTitle: "Edit Profile" });
};
export const postEdit = (req, res) => {
  return res.render("edit-profile");
};
```

```js
userRouter.route("/edit").get(getEdit).post(postEdit);
```

```pug
if loggedIn
    li
        a(href="/users/edit")  Edit Profile
    li
        a(href="/users/logout")  Log Out
    li
        a(href="/my-profile") #{loggedInUser.name}의 Profile
```

`edit-profile.pug`

```pug
form(method="POST")
    input(placeholder="Name", name="name", type="text", required, value=loggedInUser.name)
    input(placeholder="Email", name="email", type="email", required, value=loggedInUser.email)
    input(placeholder="Username", name="username", type="text", required, value=loggedInUser.username)
    input(placeholder="Location", name="location", type="text", required, value=loggedInUser.location)
    input(type="submit", value="Update Profile")
```

`middlewares.js`

```js
export const localsMiddleware = (req, res, next) => {
  res.locals.loggedIn = Boolean(req.session.loggedIn);
  res.locals.siteName = "Wetube";
  res.locals.loggedInUser = req.session.user || {};
  next();
};
```

이렇게 해서 해당 로그인 값을 세션을 통해 가져와

form value 값에 넣어 줄 수 있다.

또 로그인 하지 않고 들어 왔을 시에 `||` 를 미들웨어에 추가하므로써

실행되도록 함

## 8.1 Protector and Public Middlewares

이제 로그인 하지 않은 사람이 보호하려는 페이지에 들어가게 하려는 걸 막을 꺼임

그러기 위해서 미들웨어를 만들꺼임

사용자가 로그인 되어 있지 않으면 로그인페이지로 redirect 하게 할꺼임

```js
export const protectorMiddleware = (req, res, next) => {
  if (req.session.loggedIn) {
    next();
  } else {
    return res.redirect("/login");
  }
};
```

이제 로그인 돼 있지 않은 사람들만 접근 할 수 있게하는 미들웨어

한마디로 로그인 한사람이 `http:~~~~/login` 로 로그인 페이지를 들어 가게 되는걸 막는거임

```js
export const publicOnlyMiddleware = (req, res, next) => {
  if (!req.session.loggedIn) {
    return next();
  } else {
    return res.redirect("/");
  }
};
```

그리고 이걸 박아 놓자

`userRouter.js`

```js
import express from "express";
import {
  getEdit,
  postEdit,
  logout,
  see,
  startGithubLogin,
  finishGithubLogin,
} from "../controllers/userController";
import { protectorMiddleware, publicOnlyMiddleware } from "../middlewares";

const userRouter = express.Router();

userRouter.get("/logout", protectorMiddleware, logout);
userRouter.route("/edit").all(protectorMiddleware).get(getEdit).post(postEdit);
userRouter.get("/github/start", publicOnlyMiddleware, startGithubLogin);
userRouter.get("/github/finish", publicOnlyMiddleware, finishGithubLogin);
userRouter.get("/:id", see);

export default userRouter;
```

`rootRouter.js`

```js
rootRouter.route("/join").all(publicOnlyMiddleware).get(getJoin).post(postJoin);
rootRouter
  .route("/login")
  .all(publicOnlyMiddleware)
  .get(getLogin)
  .post(postLogin);
```

`all` 을 쓰면 어떤 method를 사용하든 `protectorMiddleware` 이걸 사용 하겠다는 거임

추가로 video 부분도 미들웨어를 적용해주자

edit, delete, upload 부분 `all("protectorMiddleware")` 해주면 됨

## 8.2 Edit Profile POST part One

edit profile 값을 받아오자

```js
export const postEdit = async (req, res) => {
  const {
    session: {
      user: { id },
    },
    body: { name, email, username, location },
  } = req;

  // const {id}  = req.session.user;
  // const {name, email, username, location} = req.body;
  await User.findByIdAndUpdate(id, { name, email, username, location });
  return res.render("edit-profile");
};
```

이렇게 하고 값을 바꿔보면

구동은 되는데 값은 바뀌지 않는다 왜 그럴까?

이유는 id 변수가 없기 때문임

정확하게는 `_id` 임

```js
console.log(req.session.user);
```

해보면 알 수 있음

그래서 `_id`로 바꾸고 다시 해보면?

여전히 안됨 왜일까?

DB에 가서 값을 보면

확실하게 값이 변경되어 있음

```
db.users.find()
```

왜냐 하면 바로 세션값은 변경이 안되서 그럼

세션은 로그인할때 기준으로 바뀌지가 않았음

그러니까 갱신해주지 않으면 세션은 로그인 기준의 값을 가지고 있는거임
