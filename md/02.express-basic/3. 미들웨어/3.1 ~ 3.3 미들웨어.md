# 3. 미들웨어

## 3.1 express 미들웨어 사용

미들웨어란?

    서로 다른 애플리케이션이 서로 통신하는 데 사용되는 소프트웨어

https://expressjs.com/ko/guide/using-middleware.html

여기에서 [서드파티 미들웨어](https://expressjs.com/ko/resources/middleware.html) 는 express 가 제공하지 않은 다른 사람이 만든 미들웨어들임

그 중에서 `body-parser` 를 써보도록 하자

https://expressjs.com/en/resources/middleware/body-parser.html

```js
var express = require("express");
var bodyParser = require("body-parser");

var app = express();

// create application/json parser
var jsonParser = bodyParser.json();

// create application/x-www-form-urlencoded parser
var urlencodedParser = bodyParser.urlencoded({ extended: false });

// POST /login gets urlencoded bodies
app.post("/login", urlencodedParser, function (req, res) {
  res.send("welcome, " + req.body.username);
});

// POST /api/users gets JSON bodies
app.post("/api/users", jsonParser, function (req, res) {
  // create user in req.body
});
```

대충 이중에 맞는 사용방법 쓰면 됨

그러면

```js
const bodyParser = require("body-parser");

app.use(bodyParser.urlencoded({ extended: false }));

app.post("/create_process", function (request, response) {
  const post = request.body;
  const title = post.title;
  const description = post.description;
  fs.writeFile(`data/${title}`, description, "utf8", function (err) {
    response.writeHead(302, { Location: `/?id=${title}` });
    response.end();
  });
});
```

이전에는

```js
const post = qs.parse(body);
```

하던걸

```js
const post = request.body;
```

이렇게 쌉 가능

## 3.2 express 미들웨어 만들기

이번에는 미들웨어를 만들어보자

https://expressjs.com/ko/guide/writing-middleware.html

미들웨어 함수는 다음과 같은 태스크를 수행할 수 있다.

- 모든 코드를 실행.
- 요청 및 응답 오브젝트에 대한 변경을 실행.
- 요청-응답 주기를 종료.
- 스택 내의 그 다음 미들웨어를 호출.

![대충미들웨어](/md/img/ExpressMiddleware.png)

대충 이렇다고 할 수 있다.

```js
var express = require("express");
var app = express();

app.get("/", function (req, res) {
  console.log("LOGGED");
  res.send("Hello World!");
});

app.post("/log", function (req, res) {
  console.log("LOGGED");
  res.send("Hello log!");
});

app.listen(3000);
```

가령 이런 코드가 있다고 했을때

```js
console.log("LOGGED");
```

이 코드가 반복 된다 할 수 있다.

이럴때 미들웨어를 만들어 반복을 제거하면

```js
var express = require("express");
var app = express();

var myLogger = function (req, res, next) {
  console.log("LOGGED");
  next();
};

app.use(myLogger);

app.get("/", function (req, res) {
  res.send("Hello World!");
});

app.post("/log", function (req, res) {
  res.send("Hello log!");
});

app.listen(3000);
```

이러면 각각의 라우터에서

```js
console.log("LOGGED");
```

가 실행 되는걸 확인할 수 있다.

여기서 get 라우터에만 적용하고 싶으면

```js
app.get("*", myLogger);
```

라고 하면 get 방식의 전체 페이지에서 myLogger 를 실행시켜라 가 된다.

## 3.3 express 미들웨어의 실행 순서

```

```
