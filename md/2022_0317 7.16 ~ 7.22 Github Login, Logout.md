## 7.16 Github Login part One

웹사이트에 소셜 로그인을 구현 할꺼임

깃헙 로그인은 좀 특이한데 기본적인 흐름은 같데

### oauthAuthorizing OAuth Apps

    다른 사용자가 OAuth 앱을 승인하도록 할 수 있음
    GitHub의 OAuth 구현은 웹 브라우저에 대한 액세스 권한이 없는 앱에 대한 표준 인증 코드 부여 유형 및 OAuth 2.0 장치 인증 부여를 지원

흐름

1. 로그인하려는 사이트에서 유저의 GitHub identity를 request하기 위해 유저를 GitHub 페이지로 리다이렉트

2. 유저는 리다이렉트된 GitHub에서 승인을 하고, GitHub에 의해 다시 로그인하려는 사이트로 리다이렉트

3. 로그인 하려는 사이트는 유저의 액세스 토큰을 통해 API에 접근

github 의 OAuth 어플리케이션에 들어가서 새로 생성해주고

해당 클라이언트 id를 포함한 링크를 구현함

```pug
    form(method="post")
        input(name="username" type="text" placeholder="Username", required)
        input(placeholder="Password", name="password", type="password", required)
        input(type="submit", value="Login")
        br
        a(href="http://github.com/login/oauth/authorize?client_id=0279511060aa22cd7a53&allow_signup=false") Continue with Github &rarr;
```

링크주소에 클라이언트id 말고도 추가적인 옵션을 넣을 수 있음

`allow_signup` 옵션은

인증되지 않은 사용자에게 OAuth 흐름 중에 GitHub에 등록할 수 있는 옵션이 제공되는지 여부

[참고자료](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps)

## 7.17 Github Login part Two

추가적인 옵션으로 scope를 쓸꺼임

`scope`

    유저에게 얼마나 많이 정보를 읽어내고 어떤정보를 가져올 것인지

[참고자료](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)

그중에서 `user:email` 를 쓸꺼임

```pug
        a(href="http://github.com/login/oauth/authorize?client_id=0279511060aa22cd7a53&allow_signup=false&scope=user:email")
```

근데 이럼 쿼리문이 너무 길어서 관리하기 힘듬

```pug
a(href="/users/github/start") Continue with Github &rarr;
```

이렇게 하고 라우터를 새로 만들꺼임

`userRouter.js`

```js
userRouter.get("/github/start", startGithubLogin);
```

`userController.js`

```js
export const startGithubLogin = (req, res) => {
  const baseUrl = "https://github.com/login/oauth/authorize";
  const config = {
    client_id: "0279511060aa22cd7a53",
    allow_signup: false,
    scope: "read:user user:email",
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  return res.redirect(finalUrl);
};
```

이제 Authorization 을 실행해보면

```
https://localhost:4000/users/github/finish?code=bd37c3ff8948ae52c699
```

코드와 함께 설정했던 콜백 url를 보내줌

```js
userRouter.get("/github/finish", finishGithubLogin);
```

```js
export const finishGithubLogin = (req, res) => {};
```

router, controller 에 새로 설정 해주자

## 7.18 Github Login part Three

github 에서 준 코드를 Access 토큰으로 바꾸자

```js
export const finishGithubLogin = async (req, res) => {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id: process.env.GH_CLIENT,
    client_secret: process.env.GH_SECRET,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  const data = await fetch(finalUrl, {
    method: "POST",
    headers: {
      Accept: "application/json",
    },
  });
  const json = await data.json();
  console.log(json);
};
```

개같은 fetch

요거 바닐라js 할때 존나 건너뛰면서 말해줬는데

이걸 저번에 우리 썻어 하면서 또 대충 넘어가네 시벌

[fetch 참고자료](https://ko.javascript.info/fetch)

[코딩애플 설명](https://www.youtube.com/watch?v=nKD1atl6cAw)

한마디로 ajax다~

## 7.19 Github Login part Four

fetch 설치

```
npm install node-fetch@2.6.1
```

현재 버전 쓰면 오류남

[ERR_REQUIRE_ESM] 가 뜸

이것은 node-fetch가 Version 3부터는 ESM-only Module이어서 그럼

공식문서에서는 CSM(CommonJS)를 쓰는 사람들은 버전 2로 쓸 것을 권장한다고 함

`userController.js`

```js
import fetch from "node-fetch";
```

import 추가
