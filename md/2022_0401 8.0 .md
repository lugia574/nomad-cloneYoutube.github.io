# 8 USER PROFILE

## 8.0 Edit Profile GET

이제 edit profile 페이지를 만들어 보자

```js
export const getEdit = (req, res) => {
  return res.render("edit-profile", { pageTitle: "Edit Profile" });
};
export const postEdit = (req, res) => {
  return res.render("edit-profile");
};
```

```js
userRouter.route("/edit").get(getEdit).post(postEdit);
```

```pug
if loggedIn
    li
        a(href="/users/edit")  Edit Profile
    li
        a(href="/users/logout")  Log Out
    li
        a(href="/my-profile") #{loggedInUser.name}의 Profile
```

`edit-profile.pug`

```pug
form(method="POST")
    input(placeholder="Name", name="name", type="text", required, value=loggedInUser.name)
    input(placeholder="Email", name="email", type="email", required, value=loggedInUser.email)
    input(placeholder="Username", name="username", type="text", required, value=loggedInUser.username)
    input(placeholder="Location", name="location", type="text", required, value=loggedInUser.location)
    input(type="submit", value="Update Profile")
```

`middlewares.js`

```js
export const localsMiddleware = (req, res, next) => {
  res.locals.loggedIn = Boolean(req.session.loggedIn);
  res.locals.siteName = "Wetube";
  res.locals.loggedInUser = req.session.user || {};
  next();
};
```

이렇게 해서 해당 로그인 값을 세션을 통해 가져와

form value 값에 넣어 줄 수 있다.

또 로그인 하지 않고 들어 왔을 시에 `||` 를 미들웨어에 추가하므로써

실행되도록 함

## 8.1 Protector and Public Middlewares

이제 로그인 하지 않은 사람이 보호하려는 페이지에 들어가게 하려는 걸 막을 꺼임

그러기 위해서 미들웨어를 만들꺼임

사용자가 로그인 되어 있지 않으면 로그인페이지로 redirect 하게 할꺼임

```js
export const protectorMiddleware = (req, res, next) => {
  if (req.session.loggedIn) {
    next();
  } else {
    return res.redirect("/login");
  }
};
```

이제 로그인 돼 있지 않은 사람들만 접근 할 수 있게하는 미들웨어

한마디로 로그인 한사람이 `http:~~~~/login` 로 로그인 페이지를 들어 가게 되는걸 막는거임

```js
export const publicOnlyMiddleware = (req, res, next) => {
  if (!req.session.loggedIn) {
    return next();
  } else {
    return res.redirect("/");
  }
};
```

그리고 이걸 박아 놓자

`userRouter.js`

```js
import express from "express";
import {
  getEdit,
  postEdit,
  logout,
  see,
  startGithubLogin,
  finishGithubLogin,
} from "../controllers/userController";
import { protectorMiddleware, publicOnlyMiddleware } from "../middlewares";

const userRouter = express.Router();

userRouter.get("/logout", protectorMiddleware, logout);
userRouter.route("/edit").all(protectorMiddleware).get(getEdit).post(postEdit);
userRouter.get("/github/start", publicOnlyMiddleware, startGithubLogin);
userRouter.get("/github/finish", publicOnlyMiddleware, finishGithubLogin);
userRouter.get("/:id", see);

export default userRouter;
```

`rootRouter.js`

```js
rootRouter.route("/join").all(publicOnlyMiddleware).get(getJoin).post(postJoin);
rootRouter
  .route("/login")
  .all(publicOnlyMiddleware)
  .get(getLogin)
  .post(postLogin);
```

`all` 을 쓰면 어떤 method를 사용하든 `protectorMiddleware` 이걸 사용 하겠다는 거임
