# 17 DEPLOYMENT

## 17.0 Building the Backend

ì´ì œ ë°±ì—”ë“œë¥¼ ì‹¤ì œ ì„œë²„ë¡œ ë°°í¬í• êº¼ì„

ê·¸ë˜ì„œ Heroko ë¥¼ í†µí•´ ë°°í¬í• ê±´ë° ì´ê²Œ ì‰½ì§€ ì•Šë°

- ì–´ë–¤ node.js í™˜ê²½ì—ì„œë„ ì„œë²„ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆê²Œ ì„¤ì •ì„ ë°”ê¿”ì•¼í•¨

- DB ì„¤ì •ë„ ë°”ê¿”ì•¼í•¨ ìš°ë¦° ã„¹ã…‡ DBë¥¼ ì“°ì§€ ì•ŠìŒ

  ã„´ ìŒ‰ ì¸ì • ë‚œ ë­” ëª½ê³ ë””ë¹„ë¥¼ ì“°ë‚˜í–ˆìŒ ì˜¤ë¼í´ì´ë‚˜ ë§ˆì´ì—ìŠ¤íì—˜ë„ ì•„ë‹ˆê³  ë­” ëª½ê³ ë””ë¹„ì—¬

- ê·¸ë¦¬ê³  íŒŒì¼ë“¤ì„ ìš°ë¦¬ ì„œë²„ê°€ ì•„ë‹ˆë¼ ì•„ë§ˆì¡´ì— ì˜¬ë ¤ì•¼í•¨

ìš°ë¦¬ì˜ ì½”ë“œë¥¼ í˜¸í™˜ì„± ìˆê²Œ ë¹Œë“œí•˜ê³  ì••ì¶•í•´ì•¼í•¨

ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´

**nodemonì„ ì‚¬ìš©í•´ì„œ basbel-nodeë¥¼ ì‹¤í–‰í•¨**

`nodemon.json`

```json
{
  "ignore": ["webpack.config.js", "src/client/*", "assets/*"],
  "exec": "babel-node src/init.js"
}
```

ë°”ë²¨ë…¸ë“œëŠ” ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ ë˜ëŠ” ê³³ì´ ì•„ë‹ˆë¼ ê°œë°œí• ë•Œë§Œ ì‚¬ìš©ë˜ëŠ” ëª©ì ì„

ì™œëƒë©´ ë°”ë²¨ë…¸ë“œëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤Œ

í•˜ì§€ë§Œ ë°”ë²¨ë…¸ë“œë¥¼ ì‚¬ìš©í•˜ë©´ í¼í¬ë¨¼ìŠ¤ ë¬¸ì œê°€ ìˆìŒ (ì†ë„)

ê·¸ë˜ì„œ `init.js` ì¼ë°˜ì ì¸ js ì½”ë“œë¡œ ë°”ê¿”ì•¼í•¨

`Babel CLI` ë¥¼ ì‚¬ìš©í• êº¼ì„ babel cli ëŠ” ë‚´ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ì½”ë“œë¥¼ ë°”ê¿”ì¤Œ

```
npm install --save-dev @babel/cli
```

scripts ë„ ë§Œë“¤ì

`package.json`

```json
  "scripts": {
    "build:server": "babel src/init.js -d build",
    "dev:server": "nodemon",
    "dev:assets": "webpack"
  },
```

`-d` ëŠ” directory ë¥¼ ì§€ì •í•´ì¤€ë‹¤ëŠ” ì†Œë¦¬ì„

ë‚´ê°€ ë¹Œë“œí•œ ì½”ë“œë¥¼ ì–´ë””ì— ì €ì¥í•  ê²ƒì¸ì§€ ë§í•˜ëŠ”ê±°ì„

```
npm run build:server
```

ì‹¤í–‰í•˜ë©´ build ë€ í´ë”ê°€ ìƒê¹€

ì•ˆì— init.jsë„ ì½”ë“œ ì‹¹ ì˜›ë‚  ì½”ë“œë¡œ ë°”ê¿”ì¤Œ

ê·¼ë° init ë§Œ ë¨ nodemonì€ íŒŒì¼ì„ ì‹¤í–‰í•˜ê³  ê·¸ íŒŒì¼ ëª¨ë“ ê±¸ ì‹¤í–‰í•¨

babelì˜ ê²½ìš° í•œ íŒŒì¼ë§Œ ì‹¤í–‰í•˜ëŠ”ê²Œ ì•„ë‹Œ, ëª¨ë“  í´ë”ë¥¼ ë¹Œë“œí•´ì„œ ì‹¤í–‰í•´ì•¼í•¨

```json
"build:server": "babel src -d build"
```

ì´ë ‡ê²Œ

ë§Œë“¤ì–´ì§„ build í´ë”ë¥¼ ì§€ìš°ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ì

ê·¸ëŸ¼ ê°œê°™ì´ ë‹¤ ìƒê¹€

.gitigonreì— ë¹Œë“œí´ë”ë¥¼ ì ì–´ ë†€ì

ì´ìœ ëŠ” ê¹ƒí—™ì— ì˜¬ë¦° í•„ìš˜ ì—†ìë‚˜

```
/node_modules
.env
/uploads
/assets
/build
```

ì½”ë“œë¥¼ ë¹Œë“œí• ë•Œ client ë¶€ë¶„ë„ ë¹Œë“œê°€ ëëŠ”ë°

ì—¬ê¸´ ì›í•˜ì§€ ì•ŠìŒ ì—¬ê¸´ ë°±ì—”ë“œ ë¶€ë¶„ì´ ì•„ë‹ˆë‹ˆê¹Œ

webpack í•˜ë‚˜ë§Œ ê°€ëŠ¥í•¨

ì´ê±¸ ì´ë”°ê°€ ê³ ì¹ êº¼ì„

ì´ì œ start ë¼ëŠ” ìƒˆë¡œìš´ ëª…ë ¹ì–´ë¥¼ ë§Œë“¤ê»€ë°

`bulid/init.js` ë¥¼ ì‹¤í–‰ í• êº¼ì„

nodemonì€ `babel-node src/init.js`ë¥¼ ì‹¤í–‰í•¨

ë‚œ node build/init.js ë¥¼ ì‹¤í–‰í• êº¼ì„

ì´ê±´ ì¼ë°˜ js ì½”ë“œë‹ˆê¹Œ nodeëŠ” babel ì—†ì´ë„ ì´í•´í•  ìˆ˜ ìˆìŒ

`npm run start` ì‹¤í–‰í•˜ë©´ ì—ëŸ¬ ëœ¸

```
ReferenceError: regeneratorRuntime is not defined
```

regeneratorRuntime ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ë°

ì´ ì—ëŸ¬ëŠ” async, await ì‚¬ìš©í• ë•Œ ëœ¨ëŠ” ì—ëŸ¬ì„

ê·¸ë¦¬ê³  pug íŒŒì¼ë“¤ì€ buildê°€ ì•ˆë¨

ì´ê±¸ ë³µì‚¬í•´ì•¼í•¨

## 17.1 Building the Backend part Two

`regeneratorRuntime` ëŠ” async ì™€ awaitë¥¼ ì“¸ ìˆ˜ ìˆê²Œ í•´ì¤Œ

ì´ ë¬¸ì œë¥¼ clientì—ì„œ ë³¸ì ì´ ìˆê³  ê³ ì³ë³¸ ì ë„ ìˆìŒ

ê·¼ë° ì™œ ë‚œ ê¸°ì–µì´ ì•ˆë‚ ê¹Œ ã…‹

ë°”ë¡œ `main.js` ì—

```js
import "regenerator-runtime";
```

ë¥¼ í•˜ë©´ ë¨

ì´ê±¸ `init.js`ì— ë˜‘ê°™ì´ í•´ì£¼ë©´ ë¨

ì´ëŸ¬ê±° ë‹¤ì‹œ ë¹Œë“œ í•´ì£¼ê³ 

start í•´ì£¼ë©´ ì„œë²„ê°€ ì˜ ì‹¤í–‰ì´ ëœë‹¤~

ì´ì œ ë°”ë²¨ì˜ ë„ì›€ ì—†ì´ node.jsê°€ ì½”ë“œë¥¼ ì˜ ì´í•´í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆê²Œë¨

ë“¤ê°€ë©´ ì˜ ë³´ì—¬ì§€ì§€ë§Œ ì‚¬ì‹¤ ì œëŒ€ë¡œëœê²Œ ì•„ë‹˜

ì™œëƒë©´ view í´ë”ê°€ build í´ë”ì— ì—†ê±°ë“ 

ê·¼ë° ì™œ ë¨?

ì´ìœ ëŠ” `server.js`

`build/server.js`

```js
app.set("views", process.cwd() + "/src/views");
```

view í´ë”ëŠ” í˜„ì¬ working directorty(=cwd) ì—ì„œ

working directortyëŠ” nodeë¥¼ ì‹¤í–‰í•œ í´ë”ìœ„ì¹˜ë¥¼ ë§í•¨

package.json ì„ ê°–ê³  ìˆëŠ” í´ë”ë¥¼ ë§í•˜ë‹ˆê¹Œ

ì˜ ëœê±°ì„

ê·¸ë˜ì„œ ì˜®ê¸¸ í•„ìš” ì—†ë°

ã…‹

ì§€ê¸ˆê¹Œì§€ ë°±ì—”ë“œ ë¹Œë“œì˜€ìŒ

ë§ë‹¤ ì´ ë¹Œë“œì„œë²„ëŠ” í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼ë„ ìŒ‰ê°€ëŠ¥ì„

```js
_mongoose["default"].connect(process.env.DB_URL, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
}); // db ì—°ê²°
```

ì—¬ê¸°ì„œ DB_URL ëŠ” .env ì—ì„œ ê°€ì ¸ì˜¨ê±°ì„

ì´ì œ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³  ì¢€ë” í”„ë¡œí˜ì…”ë„í•˜ê²Œ ë§Œë“¤ì œ

## 17.2 Building the Frontend

webpackì—ëŠ” ë‘ê°€ì§€ ëª¨ë“œê°€ ìˆìŒ

development ì™€ production

production ëª¨ë“œê°€ í›¨ì”¬ ì½”ë“œê°€ ì‘ìŒ

ê·¸ë˜ì„œ assetì„ production ëª¨ë“œë¡œ ë¹Œë“œ í• êº¼ì„

ë¨¼ì € `webpack.config.js` ì—ì„œ

```js
  mode: "development",
```

ë¥¼ ì§€ìš°ê³  ëª…ë ¹ì–´ì— ì–´ë–¤ ëª¨ë“œë¥¼ ì“¸ê»€ì§€ ì„¤ì •í•¨

`package.json`

```json
  "scripts": {
    "start": "node build/init.js",
    "build:server": "babel src -d build",
    "build:assets": "webpack --mode=  ",
    "dev:server": "nodemon",
    "dev:assets": "webpack --mode=development"
  },
```

build:assets ì´ë‚˜ dev:assets ì´ë‚˜ ëª¨ë‘ ì˜ ì‹¤í–‰ë¨

build:assets ì‹¤í–‰í•˜ê³  ê°€ì„œ ë³´ë©´ 1ì¤„ë¡œ ì¡´ë‚˜ ì••ì¶•í•´ì„œ ë³´ì—¬ì§€ê³  ìˆìŒ

ë¬¸ì œëŠ” build:assets í–ˆì§€ë§Œ ì—¬ì „íˆ watch ëª¨ë“œì„

ì˜¤ì§ dev:assets ì¼ë•Œë§Œ watch ëª¨ë“œì´ì—¬ì•¼í•¨

ê·¸ëŸ¬ë‹ˆê¹Œ webpack.config.jsì—ì„œ watch ëª¨ë“œë¥¼ ì§€ìš¸êº¼ì„

```js
  watch: true,
```

ê·¸ë¦¬ê³  watchë¥¼ ëª…ë ¹ì–´ì— ì¶”ê°€í• êº¼ì„

`package.json`

```json
"dev:assets": "webpack --mode=development -w"
```

ì´ë ‡ê²Œ í•˜ë©´ ê°œë°œìš©ì´ë“  ì œí’ˆìš©ì´ë“  ë‘˜ë‹¤ ê°™ì€ webpack ì‚¬ìš© ìŒ‰ê°€ëŠ¥

ì´ì œ Heroku ë¥¼ ì¶”ê°€í•´ë³´ì

Herokuì— ë‚´ë¶€ì— ì„œë²„ë¥¼ ë‘˜êº¼ì„

ê·¸ì „ì— build:server ë‘ build:assets ì„ ë¬¶ì–´ ë†“ì

```json
"build": "npm run build:server && npm run build:assets",
```

## 17.3 Deploying to Heroku

ì´ì œ ì„œë²„ë¥¼ Herokuì— ì˜¬ë¦´êº¼ì„

Heroku: https://www.heroku.com/

ê³„ì • ê°€ì…í•˜ê³  create appì—ì„œ ì´ë¦„ ì •í•˜ê³ 

ã„±ã„±

Herokuì— ë°±ì—”ë“œ ì„œë²„ë¥¼ ì—…ë¡œë“œí•˜ëŠ” 2ê°€ì§€ ë°©ë²•ì´ ìˆìŒ

í•˜ë‚˜ëŠ” Githubì´ê³  ë‹¤ë¥¸ í•˜ë‚œ Heroku Git ì„

ì²˜ìŒì—” Heroku Git ì„ í•´ë³¼êº¼ê³ 

ê·¸ë¦¬ê³  Github ì„ í•´ë³¼êº¼ì„

1. Heroku Git

Heroku Gitìœ¼ë¡œ ë°°í¬í•˜ë ¤ë©´ Heroku CLI ë¥¼ ì„¤ì¹˜í•´ì•¼í•¨

(ì„¤ì¹˜? ë°”ë¡œ ê¸°ê° Heroku Gitë¡œ ì—…ë¡œë“œ ì•ˆí• êº¼ì„ ã…‹)

ì»´í„°ì— ì„¤ì¹˜í•˜ê³ 

ì„¤ì¹˜ ì˜ ëëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´

```
$ heroku login
```

í•´ë³´ë˜ powershell ë§ê³  vs ì— ì¹˜ë©´ ë¨

ê¹”ë ¤ ìˆìŒ ì•„ë¬´í‚¤ë‚˜ ëˆ„ë¥´ë¼ëŠ”ë° ì•„ë¬´í‚¤ ì…ë ¥í•˜ë©´

ë¸Œë¼ìš°ì € ì—´ë¦¬ë©´ì„œ ë¡œê·¸ì¸í•˜ë¼ ê·¸ëŸ¼

ë¡œê·¸ì„ í•˜ë©´ë¨

ì´ì œ ë‚´ í”„ë¡œì íŠ¸ë¡œ ì´ë™í•´ì•¼ì§€

```
Create a new Git repository
Initialize a git repository in a new or existing directory

$ cd my-project/
$ git init
$ heroku git:remote -a lugia-wetuberealoed
```

ê·¸ë¦¬ê³ 

```
Deploy your application
Commit your code to the repository and deploy it to Heroku using Git.

$ git add .
$ git commit -am "make it better"
$ git push heroku master
```

ì´ê²Œ gitì—ì„œ add, commit ë“±ë“±ì„ í•˜ê³  push ë¥¼ íˆë¡œì¿ ì—ì„œ í•  ìˆ˜ ìˆë‹¤ëŠ” ì†Œë¦¬ì„

ë‚œ masterê°€ ì•„ë‹ˆë¼ mainìœ¼ë¡œ ë˜ì–´ ìˆë„¤ ì—¼ë³‘?

ì´ë¯¸ í”„ë¡œì íŠ¸ê°€ ìˆìœ¼ë©´

```
Existing Git repository
For existing repositories, simply add the heroku remote

$ heroku git:remote -a lugia-wetube
```

ì°¸ê³ ë¡œ

```
heroku logs --tail
```

í•˜ë©´ íˆë¡œì¿  ë¡œê·¸ë¥¼ ë³¼ìˆ˜ ìˆìŒ

í„°ë¯¸ë„ í•˜ë‚˜ ë” ë§Œë“¤ì–´ì„œ ì €ê±° ì¹˜ë©´ ë¨

ë¡œê·¸ë¥¼ ë³´ë©´

```
Starting process with command `npm start`
```

íˆë¡œì¿ ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ npm startë¥¼ ì‹¤í–‰í•¨

ê·¸ë¦¬ê³ 

```
Error: Cannot init client. Please provide correct options
```

í´ë¼ì´ì–¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ê°€ ì—†ë‹¤ëŠ”ë°

ì´ìœ ëŠ”

```
Assertion failed: You must provide either mongoUrl|clientPromise|client in options
```

DB_URLì´ `.env` íŒŒì¼ì— ìˆì–´ íˆë¡œì¿ ê°€ ì°¾ì§€ ëª»í•œë‹¤ëŠ” ì†Œë¦¬ì„

## 17.4 MongoDB Atlas

ê³„ì •ì„ ë§Œë“¤ê³  ë¬´ë£Œ DBê¹Œì§€ í•˜ë©´

ì´ì œ í´ëŸ¬ìŠ¤í„°ì— connectionì„ ëˆ„ë¥´ë©´ ë¨

Add a connection IP address

ë¼ê³  ìˆëŠ”ë° Allow Access from Anywhere ì´ë¼ê³ 

ëª¨ë‘ì—ê²Œ ê³µê°œí•˜ëŠ”ê±° ëˆ„ë¥´ë©´ ë¨

ê·¸ë¦¬ê³ 

Create a Database User ì—ì„œ DB ê³„ì • ì´ë¦„ì´ë‘ ë¹„ë²ˆì„ ì •í•´ì•¼í•´

ì—¬ê¸°ì„œ ë¹„ë²ˆì€ ë°˜ë“œì‹œ ì•ˆì „í•´ì•¼í•¨

ê·¸ë˜ì„œ ìë™ìƒì„± ã„±ã„±

ìƒˆ íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ê·¸ ë²ˆí˜¸ë¥¼ ì €ì¥í•˜ì

ê·¸ë¦¬ê³  Create Database User ëˆ„ë¦„ ë¨

Choose a connection method, ì—°ê²°ë°©ì‹ ì„ íƒí•˜ê¸° ëˆŒëŸ¬

MongoDB ì˜ native driver ë¥¼ ì‚¬ìš©í•´ì„œ ì•±ê³¼ ì—°ê²° í• êº¼ë‹ˆê¹Œ

connection your application ëˆŒëŸ¬ì¤˜

ëˆ„ë¥´ë©´ ì£¼ì†Œê°€ ë‚˜ì˜¤ëŠ”ë°

```
mongodb+srv://lugiacoders:<password>@cluster0.j16k7at.mongodb.net/?retryWrites=true&w=majority
```

ì´ê²Œ ë°”ë¡œ DB_URL ì„
.env ì— ìˆëŠ” DB_URL ì—­í™œ í•˜ëŠ”ê±°ì„

ì—¬ê¸° password ìë¦¬ì— ì•„ê¹Œ ë°›ì€ ë¹„ë²ˆ ë°•ìŒ ë¨

íˆë¡œì¿ ì— ë³€ìˆ˜ ì„¤ì •ì„ í•˜ë©´ ë˜ëŠ”ë°

ë‚´êº¼ íˆë¡œì¿  ë“¤ê°€ì„œ setting ã„±ã„±

ê±°ê¸°ì„œ Reveal Config Vars ëˆŒëŸ¬ì„œ ë³€ìˆ˜ ì¶”ê°€í•˜ë©´ ë¨

ë³€ìˆ˜ëª… DB_URL ì´ë‘ ê°’ ã„±ã„±

ë¡œê·¸ì°½ ë³´ë©´

```
 Set DB_URL config vars by user ~~
```

ë¼ê³  DB_URLê°’ì´ ì •í•´ì¡Œë‹¤ê³  ë‚˜ì˜´

```
2022-06-02T03:54:35.415796+00:00 app[web.1]: âœ… Server listenting on port http://localhost:4000 ğŸš€
2022-06-02T03:54:37.038302+00:00 app[web.1]: âœ… Connected to DB ğŸ˜
```

ê·¸ë¦¬ê³  ì´ë ‡ê²Œ ì—°ê²°ëë‹¤ê³  ë‚˜ì˜´! ã…‹

ì´ëŸ¬ê³  íˆë¡œì¿ ì— ì˜¤í”ˆ ì•± í•˜ë©´ ì•ˆë¨ ì‘ë‹µì´ ì—†ì–´

ì™œ ì„œë²„ê°€ ì•ˆì—´ë¦´ê¹Œ?

```
Error R10 (Boot timeout) -> Web process failed to bind to $PORT within 60 seconds of launch
```

ì´ëŸ° ì˜¤ë¥˜ê°€ ëœ¨ëŠ”ë°

ê·¸ê±´ ì´ë”°ê°€ í•˜ê³  ìš°ì„  .envì— ìˆì–´ì„œ ê°€ì ¸ì˜¬ìˆ˜ ì—†ëŠ” ë³€ìˆ˜ê°’ë“¤ì„

íˆë¡œì¿ ì—ì„œ ì„¤ì •í•´ì£¼ì

COOKIE_SECRET ì€ ë‚´ê°€ ì•„ë¬´ë ‡ê²Œë‚˜ ë§‰ ì¨ì„œ ë°•ìŒ ë¨

## 17.5 Environment Variables

ì§€ê¸ˆ í¬íŠ¸ê°€ 4000ìœ¼ë¡œ ìš°ë¦¬ê°€ ì§€ì •í•œê±° ì“°ê³  ìˆëŠ”ë°

ì´ë ‡ê²Œ í•˜ë©´ íˆë¡œì¿ ê°€ ì§€ì •í•´ì£¼ëŠ” í¬íŠ¸ë¥¼ ëª»ì”€

```js
const PORT = process.env.PORT || 4000;
```

ì´ë ‡ê²Œ í•´ì£¼ë©´ íˆë¡œì¿ ì—ì„œ ì‹¤í–‰í•˜ë©´ ê·¸ í¬íŠ¸ë¡œ í•˜ê³ 

ë‚´ ì»´í“¨í„°ë¡œ ì‹¤í–‰í•˜ë©´ 4000ìœ¼ë¡œ ì‹¤í–‰ í•´ì¤„êº¼ì„

```
2022-06-02T04:02:51.024156+00:00 app[web.1]: âœ… Server listenting on port http://localhost:32277 ğŸš€
2022-06-02T04:02:52.649983+00:00 app[web.1]: âœ… Connected to DB ğŸ˜
```

ì‹¤ì œë¡œ 4000ì´ ì•„ë‹Œ íˆë¡œì¿ ê°€ ì¤€ í¬íŠ¸ ë²ˆí˜¸ê°€ ë‚˜ì˜¨ë‹¤ êµ¿ ã…‹

ì´ì œ DBë‘ ì—°ê²°ë„ í–ˆê³  í¬íŠ¸ë„ ì œëŒ€ë¡œ ë°›ìŒ

íˆë¡œì¿  ê°€ì„œ ì˜¤í”ˆì•± ëˆ„ë¥´ë©´

í‚¤ì•¼~~~~~~~~ ã„¹ã…‡ã„¹ã…‡ã„¹ã…‡ã„¹ã…‡ë£¨ í™ˆí˜ì´ì§€ê°€ ë‚˜ì˜¨ë‹¤ì‰~

ë„ˆë¬´ ì–´ì¸í•˜ìë„ˆ~

ê·¼ë° ë¹„ë””ì˜¤ê°€ ì—†ì–´

ì™œì¼ê¹Œ?

DBì— ì—†ìœ¼ë‹ˆê¹Œ~

ê¸€ê³  ë˜ ë¬¸ì œê°€ í•˜ë‚˜ ìˆìŒ

ê¹ƒí—™ìœ¼ë¡œ ë¡œê·¸ì¸ í•˜ë ¤ë©´ 404 ëœ¸

ì´ê²ƒ ì—­ì‹œ `.env` ì— ìˆëŠ” ë³€ìˆ˜ ë¬¸ì œì„

íˆë¡œì¿  ê°€ì„œ GH_CLIENT ë‘ GH_SECRET ë³€ìˆ˜ ì„¤ì •í•´ì£¼ì

## 17.6 Github and AWS S3 part One

ë¡œê·¸ì¸ í•˜ë©´ ì´ì   ì—°ê²°í• ìˆ˜ ì—†ë‹¤ê³  ëœ¸

ê·¸ ì´ìœ ëŠ” ë°”ë¡œ

ì•„ì§ë„ ê¹ƒí—™ì€ localhostë¡œ ì´ì£¼ê¸° ë•Œë¬¸ì—~

Github App ê°€ì„œ Authorization callback URL ìˆ˜ì • ã„±ã„±

ì´ê²Œ ë‚´ê°€ ë”°ë¡œ í…ŒìŠ¤íŠ¸ í• ë•ŒëŠ” ë˜ ê°€ì„œ ìˆ˜ì • í•´ì¤˜ì•¼í•˜ëŠ”ë°

ì´ê²Œ ì¡´ë‚˜ ê·€ì°®ë° ê·¸ë˜ì„œ ì•±ì„ 2ê°œ ë§Œë“¤ë¼ê³  í•˜ëŠ”ë°

í…ŒìŠ¤íŠ¸ìš© í‚¤ê°’ë“¤ì„ `.env`ì— ë°•ìŒ ëœë‹¤ëŠ”ë°

ì‘ ê·¸ê²ƒë„ ê·€ì°®ì•„ ã…‹ ë‚˜ì¤‘ì— ã…‹ ê·¸ë•Œ ê°€ì„œ ã…‹

ì—¬íŠ¼ ë°”ê¾¸ê³  ë¡œê·¸ì¸ í•´ì£¼ë©´ í¬~ ì—°ê²°ëì§€ì—¬~

mongo Atlas ê°€ì„œ ë³´ë©´ ì‹¤ì œ ìœ ì € ì •ë³´ê¹Œì§€ ìˆìŒ ã…‹

ì´ì œ github ìœ¼ë¡œ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ í•´ë³´ì

ì¡´ë‚˜ ì‰¬ì›€ ê·¸ëƒ¥ ì—°ê²°í•˜ëŠ”ë°ì—ì„œ ê¹ƒí—™ ëˆ„ë¥´ê³ 

ê²€ìƒ‰í•˜ê³  ì—°ê²°í•˜ë©´ ë¨

ì´ì œ git push heroku main ì•ˆí•´ë„ ë¨

git push origin main í•˜ë©´ ë¨ ã…‹

ì°¸ê³ ë¡œ ë‚´ê°€ ìƒˆë¡­ê²Œ commit ë¥¼ í• ë•Œë§ˆë‹¤

ë‚´ê°€ íˆë¡œì¿ ë¡œ ì˜¬ë ¸ë˜ ì˜ìƒ, ì´ë¯¸ì§€ ê°™ì€ê²ƒë“¤ì´ ë‹¤ ì‚¬ë¼ì§

ê¸€ì€ ìˆëŠ”ë° ì•ˆì— ë¹„ë””ì˜¤ê°€ ì—†ê³  ì´ë¯¸ì§€ë„ ì•ˆëœ¨ê³  ì¡´ë‚˜ ë³„ë¡œ

ê·¸ë˜ì„œ íˆë¡œì¿  ì„œë²„ì— ì˜¬ë ¤ì¡Œì§€ë§Œ commit ë˜ë©´

ì„œë²„ë¥¼ ì•„ì˜ˆ ìƒˆì„œë²„ë¡œ ë‹¤ì‹œ ì—¬ë‹ˆ ê±°ê¸°ì—ëŠ” ì—†ì–´ì„œ ë‹¤ ì§€ì›Œì§€ëŠ”ê±°ì„

## 17.7 AWS S3 part Two

ì„œë²„ì— íŒŒì¼ì„ ì €ì¥í•˜ëŠ”ê±¸ ì´ì œ ê·¸ë§Œ ë‘˜êº¼ì„

íŒŒì¼ì„ ì €ì¥í•˜ê¸° ìœ„í•´ AWS ë¥¼ ì“¸êº¼ì„

ê³„ì • ê°€ì…í•˜ê³ 

AWS S3 ë¡œ ì´ë™

ë²„ì¼“ë§Œë“¤ê¸° ëˆ„ë¥´ë©´ ë¨

ê±°ê¸°ì„œ ì´ë¦„ì„ ì •í•´ì•¼í•˜ëŠ”ë°

ì •í•˜ê³  ë‹¤ë¥¸ê±° ê±´ë“¤ì§€ ë§ê³  ë§Œë“¤ê¸° ã„±

API í‚¤ë¥¼ ë§Œë“¤ì–´ì•¼í•¨

ê±°ê¸°ì„œ IAM ê²€ìƒ‰í•´ì„œ ã„±ã„±ã„±

IAMì€ API í‚¤ë¥¼ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆìŒ

user ë“¤ê°€ì„œ

ì‚¬ìš©ì ì¶”ê°€

ì´ë¦„ ë­ ê¸°ì–µí• ì •ë„ë¡œ ê¸¸ê²Œ ì“°ë¼ëŠ”ë° ì™œ ê¸¸ê²Œ ì“°ëŠ”ê²Œ ê¸°ì–µë‚˜ëŠ”ê±´ì§€ ëª°ê² ìŒ ì—¬íŠ¼ ë‹ˆì½” ë”°ë¼ ê·¸ëŒ€ë¡œ ì”€

WetubReloadedUploader

ê·¸ë¦¬ê³  ì•¡ì„¸ìŠ¤ í‚¤ â€“ í”„ë¡œê·¸ë˜ë° ë°©ì‹ ì•¡ì„¸ìŠ¤ ì²´í¬

ê¶Œí•œìœ¼ë¡œ ë„˜ì–´ê°€ì„œ

ê¸°ì¡´ ì •ì±… ì§ì ‘ ì—°ê²°ìœ¼ë¡œ S3 ê²€ìƒ‰í•˜ë©´

AmazonS3FullAccess

ì´ê²Œ ìˆìŒ

íŒŒì¼ì— ëŒ€í•´ì„œë§Œ ê¶Œí•œ ì£¼ëŠ” ê±°ì„

íƒœê·¸ë¡œ ë„˜ì–´ê°€ì„œ ë­ ì¤„êº¼ ì—†ìœ¼ë‹ˆê¹Œ ë„˜ì–´ê°€

ì‚¬ìš©ì ë§Œë“¤ê¸° ã„±ã„± í•˜ë©´ ë¨

ì´ëŸ¼ ì—‘ì„¸ìŠ¤ KeyID ë‘ Keyê°€ ìƒê¹€

.env ë“¤ê°€ì„œ AWS_ID, AWS_SECRET ë¼ê³  ì €ì¥í•´ì¤Œ

ë§ˆì°¬ê°€ì§€ë¡œ íˆë¡œì¿  ê°€ì„œ ì €ì¥ ã„±ã„±

ì´ì œ multer s3 ë¼ëŠ” íŒ¨í‚¤ì§€ ì‚¬ìš©í•´ì•¼í•¨

Multer S3 (AWS S3ìš© ìŠ¤íŠ¸ë¦¬ë° Multer ìŠ¤í† ë¦¬ì§€ ì—”ì§„)

AWS-SDK (JavaScriptìš© AWS SDK)

```
npm i multer-s3
npm i aws-sdk
```

ê·¸ë¦¬ê³  `middlewara.js` ê°€ì„œ ìŠ¤í† ë¦¬ì§€ ì„¤ì •ì„ í•´ì¤˜ì•¼í•¨

```js
import multer from "multer";
import multerS3 from "multer-s3";
import aws from "aws-sdk";

const s3 = new aws.S3({
  credentials: {
    accessKeyId: process.env.AWS_ID,
    secretAccessKey: process.env.AWS_SECRET,
  },
});

const multerUploader = multerS3({
  s3: s3,
  bucket: "lugia-wetube",
});

//....ìƒëµ....

export const avatarUpload = multer({
  dest: "uploads/avatars/",
  limits: { fileSize: 3000000 },
  storage: multerUploader,
});
export const videoUpload = multer({
  dest: "uploads/videos/",
  limits: { fileSize: 100000000 },
  storage: multerUploader,
});
```

ìš”ë¡œê±° ë‚´ ì»´í“¨í„°ë¡œ ë“¤ê°€ì„œ í•¨ ì„¬ë„¤ì¼ ë°”ê¿”ë³´ë‹ˆê¹Œ ì—ëŸ¬ ëœ¸

```
22.05.29 ê¸°ì¤€ìœ¼ë¡œ, multer-s3 ì™€ aws-sdk ì˜ ìµœê·¼ ì—…ë°ì´íŠ¸ì˜ ì˜í–¥ì¸ì§€, ë‘ ëª¨ë“ˆì„ ìµœì‹ ìœ¼ë¡œ ì„¤ì¹˜í•˜ê³  ê°•ì˜ë¥¼ ë”°ë¼ê°€ë‹¤ë³´ë©´ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
`TypeError: this.client.send is not a function`
êµ¬ê¸€ë§í•´ë„ ì°¾ì•„ì§€ëŠ” ê²ƒë„ ì—†ê³  í•˜ë‹¤ê°€, ì œê°€ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ 4ì‹œê°„ ì „ì— ì—…ë¡œë“œëœ multer-s3 issue ê°€ ìˆëŠ”ê±¸ ë³´ê³  ë­”ê°€ ëŠë‚Œì´ ì™€ì„œ multer ì™€ aws-sdk module ë²„ì „ì„ ë‹ˆê¼¬ìŒ¤ pacakge.json ì„ ë³´ê³  ë§ì·„ë”ë‹ˆ ì—ëŸ¬ ì—†ì´ íŒŒì¼ ì—…ë¡œë“œê°€ ì˜ ë˜ë„¤ìš” .. ì´ê±°ì°¾ì•„ë³¸ë‹¤ê³  í•œ ì‹œê°„ ë™ì•ˆ ì‚½ì§ˆì„ ã… ã… ..

ë²„ì „ì€ package.json ì— ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•´ì¤¬ê³ ,
"aws-sdk": "~2.895.0",
"multer": "~1.4.2",
"multer-s3": "~2.9.0",

node_modules í´ë” ì‚­ì œ í›„ npm i ìœ¼ë¡œ ëª¨ë“ˆë“¤ ì¬ ì„¤ì¹˜ í›„ npm list ë¡œ ìœ„ì— ëª…ì‹œí•œ ë²„ì „ì´ ë§ê²Œ ì„¤ì¹˜í•˜ì‹  í›„ ë™ì‘ í™•ì¸í•˜ì‹œë©´ ë˜ê² ìŠµë‹ˆë‹¤.
https://github.com/anacronw/multer-s3/issues/169
```

ì—¬íŠ¼ ë²„ì¼“ì— ê°€ë©´ ë‚´ê°€ ë°”ê¾¼ ì´ë¯¸ì§€ê°€ ì˜¬ë ¤ì ¸ ìˆìŒ

## 17.8 AWS S3 part Three

s3ì—ì„œ ê¶Œí•œ

ìƒˆ í¼ë¸”ë¦­ ë²„í‚· ë˜ëŠ” ì•¡ì„¸ìŠ¤ ì§€ì  ì •ì±…ì„ í†µí•´ ë¶€ì—¬ëœ ë²„í‚· ë° ê°ì²´ì— ëŒ€í•œ í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨

ì„ì˜ì˜ í¼ë¸”ë¦­ ë²„í‚· ë˜ëŠ” ì•¡ì„¸ìŠ¤ ì§€ì  ì •ì±…ì„ í†µí•´ ë¶€ì—¬ëœ ë²„í‚· ë° ê°ì²´ì— ëŒ€í•œ í¼ë¸”ë¦­ ë° êµì°¨ ê³„ì • ì•¡ì„¸ìŠ¤ ì°¨ë‹¨

ìš”ê±° 2ê°œë§Œ ì°¨ë‹¨ ã„±

```js
const multerUploader = multerS3({
  s3: s3,
  bucket: "lugia-wetube",
  acl: "public-read",
});
```

acl: "public-read", ì¶”ê°€

AccessControlListNotSupported: The bucket does not allow ACLs ì´ëŸ¬ê³  ì˜¤ë¥˜ ëœ¸ ã…¡ã…¡;

[AccessControlListNotSupported: The bucket does not allow ACLs ì˜¤ë¥˜ í•´ê²°]

ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ëœ¨ì‹œëŠ” ë¶„ë“¤ì€ ë²„í‚·ì— ACLê¶Œí•œì„ ë³€ê²½í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

ê¶Œí•œ -> ê°ì²´ ì†Œìœ ê¶Œ í¸ì§‘ -> ACL ë¹„í™œì„±í™”ë¨(ê¶Œì¥)ì„ ACL í™œì„±í™”ë¨ë¡œ ë³€ê²½ ->
ACLì´ ë³µì›ëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤. ì²´í¬ -> ë²„í‚· ì†Œìœ ì ì„ í˜¸ ì²´í¬ -> ë³€ê²½ì‚¬í•­ ì €ì¥
ìœ„ì˜ ë°©ë²•ê¹Œì§€ í•´ë³´ì‹œê³ , ê·¸ë˜ë„ ì•ˆ ë˜ì‹œëŠ” ë¶„ë“¤ì€ ACL(ì•¡ì„¸ìŠ¤ ì œì–´ ëª©ë¡)ì—ì„œ í¸ì§‘->ëª¨ë“  ì‚¬ëŒ(í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤)ì— ë‚˜ì—´, ì½ê¸° ì²´í¬í•´ì£¼ì‹  í›„ ë³€ê²½ì‚¬í•­ ì €ì¥í•´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì‹œë©´ ë  ê±° ê°™ìŠµë‹ˆë‹¤.

[No 'Access-Control-Allow-Origin' header is present on the requested resource. ì˜¤ë¥˜ í•´ê²°]

ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ì½˜ì†”ì°½ì— ëœ¨ì‹œëŠ” ë¶„ë“¤ì€ ê¶Œí•œ -> CORS(Cross-origin ë¦¬ì†ŒìŠ¤ ê³µìœ ) í¸ì§‘ -> ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì‹œê³  ë³€ê²½ì‚¬í•­ ì €ì¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
https://stackoverflow.com/questions/17533888/s3-access-control-allow-origin-header

```
[
{
"AllowedHeaders": [
"*"
],
"AllowedMethods": [
"GET",
"HEAD"
],
"AllowedOrigins": [
"*"
],
"ExposeHeaders": [],
"MaxAgeSeconds": 3000
}
]
```

- ì¶”ê°€ì ìœ¼ë¡œ ì´ë¯¸ì§€ íƒœê·¸ì™€ ë¹„ë””ì˜¤ íƒœê·¸ì— crossoriginì†ì„±ì„ ì¶”ê°€í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
  img(src=`ì´ë¯¸ì§€ ì£¼ì†Œ` crossorigin)
  video(src=`ë¹„ë””ì˜¤ ì£¼ì†Œ` crossorigin)

CORS êµ¬ì„±
Cross-Origin ìš”ì²­ì„ í—ˆìš©í•˜ë„ë¡ ë²„í‚·ì„ êµ¬ì„±í•˜ë ¤ë©´ CORS êµ¬ì„±ì„ ìƒì„±í•©ë‹ˆë‹¤.
https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ManageCorsUsing.html

AllowedOriginsì„ ì„¤ì •í•˜ëŠ” ì´ìœ 
í—ˆìš©í•˜ì§€ ì•Šì€ originì—ì„œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ ë° ì‚¬ìš©ì„ ë§‰ê¸° ìœ„í•´ì„œì´ë‹¤.
ë‹¤ì‹œ ë§í•´, í—ˆìš©í•˜ì§€ ì•Šì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¦¬ì†ŒìŠ¤ë¥¼ ì£¼ì§€ ì•Šê¸° ìœ„í•¨ì´ê³ , í—ˆìš©í•  ëŒ€ìƒì— ëŒ€í•œ ì„¤ì •ì´ AllowedOriginsì´ë‹¤.
