# 17 DEPLOYMENT

## 17.0 Building the Backend

ì´ì œ ë°±ì—”ë“œë¥¼ ì‹¤ì œ ì„œë²„ë¡œ ë°°í¬í• êº¼ì„

ê·¸ë˜ì„œ Heroko ë¥¼ í†µí•´ ë°°í¬í• ê±´ë° ì´ê²Œ ì‰½ì§€ ì•Šë°

- ì–´ë–¤ node.js í™˜ê²½ì—ì„œë„ ì„œë²„ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆê²Œ ì„¤ì •ì„ ë°”ê¿”ì•¼í•¨

- DB ì„¤ì •ë„ ë°”ê¿”ì•¼í•¨ ìš°ë¦° ã„¹ã…‡ DBë¥¼ ì“°ì§€ ì•ŠìŒ

  ã„´ ìŒ‰ ì¸ì • ë‚œ ë­” ëª½ê³ ë””ë¹„ë¥¼ ì“°ë‚˜í–ˆìŒ ì˜¤ë¼í´ì´ë‚˜ ë§ˆì´ì—ìŠ¤íì—˜ë„ ì•„ë‹ˆê³  ë­” ëª½ê³ ë””ë¹„ì—¬

- ê·¸ë¦¬ê³  íŒŒì¼ë“¤ì„ ìš°ë¦¬ ì„œë²„ê°€ ì•„ë‹ˆë¼ ì•„ë§ˆì¡´ì— ì˜¬ë ¤ì•¼í•¨

ìš°ë¦¬ì˜ ì½”ë“œë¥¼ í˜¸í™˜ì„± ìˆê²Œ ë¹Œë“œí•˜ê³  ì••ì¶•í•´ì•¼í•¨

ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´

**nodemonì„ ì‚¬ìš©í•´ì„œ basbel-nodeë¥¼ ì‹¤í–‰í•¨**

`nodemon.json`

```json
{
  "ignore": ["webpack.config.js", "src/client/*", "assets/*"],
  "exec": "babel-node src/init.js"
}
```

ë°”ë²¨ë…¸ë“œëŠ” ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ ë˜ëŠ” ê³³ì´ ì•„ë‹ˆë¼ ê°œë°œí• ë•Œë§Œ ì‚¬ìš©ë˜ëŠ” ëª©ì ì„

ì™œëƒë©´ ë°”ë²¨ë…¸ë“œëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤Œ

í•˜ì§€ë§Œ ë°”ë²¨ë…¸ë“œë¥¼ ì‚¬ìš©í•˜ë©´ í¼í¬ë¨¼ìŠ¤ ë¬¸ì œê°€ ìˆìŒ (ì†ë„)

ê·¸ë˜ì„œ `init.js` ì¼ë°˜ì ì¸ js ì½”ë“œë¡œ ë°”ê¿”ì•¼í•¨

`Babel CLI` ë¥¼ ì‚¬ìš©í• êº¼ì„ babel cli ëŠ” ë‚´ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ì½”ë“œë¥¼ ë°”ê¿”ì¤Œ

```
npm install --save-dev @babel/cli
```

scripts ë„ ë§Œë“¤ì

`package.json`

```json
  "scripts": {
    "build:server": "babel src/init.js -d build",
    "dev:server": "nodemon",
    "dev:assets": "webpack"
  },
```

`-d` ëŠ” directory ë¥¼ ì§€ì •í•´ì¤€ë‹¤ëŠ” ì†Œë¦¬ì„

ë‚´ê°€ ë¹Œë“œí•œ ì½”ë“œë¥¼ ì–´ë””ì— ì €ì¥í•  ê²ƒì¸ì§€ ë§í•˜ëŠ”ê±°ì„

```
npm run build:server
```

ì‹¤í–‰í•˜ë©´ build ë€ í´ë”ê°€ ìƒê¹€

ì•ˆì— init.jsë„ ì½”ë“œ ì‹¹ ì˜›ë‚  ì½”ë“œë¡œ ë°”ê¿”ì¤Œ

ê·¼ë° init ë§Œ ë¨ nodemonì€ íŒŒì¼ì„ ì‹¤í–‰í•˜ê³  ê·¸ íŒŒì¼ ëª¨ë“ ê±¸ ì‹¤í–‰í•¨

babelì˜ ê²½ìš° í•œ íŒŒì¼ë§Œ ì‹¤í–‰í•˜ëŠ”ê²Œ ì•„ë‹Œ, ëª¨ë“  í´ë”ë¥¼ ë¹Œë“œí•´ì„œ ì‹¤í–‰í•´ì•¼í•¨

```json
"build:server": "babel src -d build"
```

ì´ë ‡ê²Œ

ë§Œë“¤ì–´ì§„ build í´ë”ë¥¼ ì§€ìš°ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ì

ê·¸ëŸ¼ ê°œê°™ì´ ë‹¤ ìƒê¹€

.gitigonreì— ë¹Œë“œí´ë”ë¥¼ ì ì–´ ë†€ì

ì´ìœ ëŠ” ê¹ƒí—™ì— ì˜¬ë¦° í•„ìš˜ ì—†ìë‚˜

```
/node_modules
.env
/uploads
/assets
/build
```

ì½”ë“œë¥¼ ë¹Œë“œí• ë•Œ client ë¶€ë¶„ë„ ë¹Œë“œê°€ ëëŠ”ë°

ì—¬ê¸´ ì›í•˜ì§€ ì•ŠìŒ ì—¬ê¸´ ë°±ì—”ë“œ ë¶€ë¶„ì´ ì•„ë‹ˆë‹ˆê¹Œ

webpack í•˜ë‚˜ë§Œ ê°€ëŠ¥í•¨

ì´ê±¸ ì´ë”°ê°€ ê³ ì¹ êº¼ì„

ì´ì œ start ë¼ëŠ” ìƒˆë¡œìš´ ëª…ë ¹ì–´ë¥¼ ë§Œë“¤ê»€ë°

`bulid/init.js` ë¥¼ ì‹¤í–‰ í• êº¼ì„

nodemonì€ `babel-node src/init.js`ë¥¼ ì‹¤í–‰í•¨

ë‚œ node build/init.js ë¥¼ ì‹¤í–‰í• êº¼ì„

ì´ê±´ ì¼ë°˜ js ì½”ë“œë‹ˆê¹Œ nodeëŠ” babel ì—†ì´ë„ ì´í•´í•  ìˆ˜ ìˆìŒ

`npm run start` ì‹¤í–‰í•˜ë©´ ì—ëŸ¬ ëœ¸

```
ReferenceError: regeneratorRuntime is not defined
```

regeneratorRuntime ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ë°

ì´ ì—ëŸ¬ëŠ” async, await ì‚¬ìš©í• ë•Œ ëœ¨ëŠ” ì—ëŸ¬ì„

ê·¸ë¦¬ê³  pug íŒŒì¼ë“¤ì€ buildê°€ ì•ˆë¨

ì´ê±¸ ë³µì‚¬í•´ì•¼í•¨

## 17.1 Building the Backend part Two

`regeneratorRuntime` ëŠ” async ì™€ awaitë¥¼ ì“¸ ìˆ˜ ìˆê²Œ í•´ì¤Œ

ì´ ë¬¸ì œë¥¼ clientì—ì„œ ë³¸ì ì´ ìˆê³  ê³ ì³ë³¸ ì ë„ ìˆìŒ

ê·¼ë° ì™œ ë‚œ ê¸°ì–µì´ ì•ˆë‚ ê¹Œ ã…‹

ë°”ë¡œ `main.js` ì—

```js
import "regenerator-runtime";
```

ë¥¼ í•˜ë©´ ë¨

ì´ê±¸ `init.js`ì— ë˜‘ê°™ì´ í•´ì£¼ë©´ ë¨

ì´ëŸ¬ê±° ë‹¤ì‹œ ë¹Œë“œ í•´ì£¼ê³ 

start í•´ì£¼ë©´ ì„œë²„ê°€ ì˜ ì‹¤í–‰ì´ ëœë‹¤~

ì´ì œ ë°”ë²¨ì˜ ë„ì›€ ì—†ì´ node.jsê°€ ì½”ë“œë¥¼ ì˜ ì´í•´í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆê²Œë¨

ë“¤ê°€ë©´ ì˜ ë³´ì—¬ì§€ì§€ë§Œ ì‚¬ì‹¤ ì œëŒ€ë¡œëœê²Œ ì•„ë‹˜

ì™œëƒë©´ view í´ë”ê°€ build í´ë”ì— ì—†ê±°ë“ 

ê·¼ë° ì™œ ë¨?

ì´ìœ ëŠ” `server.js`

`build/server.js`

```js
app.set("views", process.cwd() + "/src/views");
```

view í´ë”ëŠ” í˜„ì¬ working directorty(=cwd) ì—ì„œ

working directortyëŠ” nodeë¥¼ ì‹¤í–‰í•œ í´ë”ìœ„ì¹˜ë¥¼ ë§í•¨

package.json ì„ ê°–ê³  ìˆëŠ” í´ë”ë¥¼ ë§í•˜ë‹ˆê¹Œ

ì˜ ëœê±°ì„

ê·¸ë˜ì„œ ì˜®ê¸¸ í•„ìš” ì—†ë°

ã…‹

ì§€ê¸ˆê¹Œì§€ ë°±ì—”ë“œ ë¹Œë“œì˜€ìŒ

ë§ë‹¤ ì´ ë¹Œë“œì„œë²„ëŠ” í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼ë„ ìŒ‰ê°€ëŠ¥ì„

```js
_mongoose["default"].connect(process.env.DB_URL, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
}); // db ì—°ê²°
```

ì—¬ê¸°ì„œ DB_URL ëŠ” .env ì—ì„œ ê°€ì ¸ì˜¨ê±°ì„

ì´ì œ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³  ì¢€ë” í”„ë¡œí˜ì…”ë„í•˜ê²Œ ë§Œë“¤ì œ

## 17.2 Building the Frontend

webpackì—ëŠ” ë‘ê°€ì§€ ëª¨ë“œê°€ ìˆìŒ

development ì™€ production

production ëª¨ë“œê°€ í›¨ì”¬ ì½”ë“œê°€ ì‘ìŒ

ê·¸ë˜ì„œ assetì„ production ëª¨ë“œë¡œ ë¹Œë“œ í• êº¼ì„

ë¨¼ì € `webpack.config.js` ì—ì„œ

```js
  mode: "development",
```

ë¥¼ ì§€ìš°ê³  ëª…ë ¹ì–´ì— ì–´ë–¤ ëª¨ë“œë¥¼ ì“¸ê»€ì§€ ì„¤ì •í•¨

`package.json`

```json
  "scripts": {
    "start": "node build/init.js",
    "build:server": "babel src -d build",
    "build:assets": "webpack --mode=  ",
    "dev:server": "nodemon",
    "dev:assets": "webpack --mode=development"
  },
```

build:assets ì´ë‚˜ dev:assets ì´ë‚˜ ëª¨ë‘ ì˜ ì‹¤í–‰ë¨

build:assets ì‹¤í–‰í•˜ê³  ê°€ì„œ ë³´ë©´ 1ì¤„ë¡œ ì¡´ë‚˜ ì••ì¶•í•´ì„œ ë³´ì—¬ì§€ê³  ìˆìŒ

ë¬¸ì œëŠ” build:assets í–ˆì§€ë§Œ ì—¬ì „íˆ watch ëª¨ë“œì„

ì˜¤ì§ dev:assets ì¼ë•Œë§Œ watch ëª¨ë“œì´ì—¬ì•¼í•¨

ê·¸ëŸ¬ë‹ˆê¹Œ webpack.config.jsì—ì„œ watch ëª¨ë“œë¥¼ ì§€ìš¸êº¼ì„

```js
  watch: true,
```

ê·¸ë¦¬ê³  watchë¥¼ ëª…ë ¹ì–´ì— ì¶”ê°€í• êº¼ì„

`package.json`

```json
"dev:assets": "webpack --mode=development -w"
```

ì´ë ‡ê²Œ í•˜ë©´ ê°œë°œìš©ì´ë“  ì œí’ˆìš©ì´ë“  ë‘˜ë‹¤ ê°™ì€ webpack ì‚¬ìš© ìŒ‰ê°€ëŠ¥

ì´ì œ Heroku ë¥¼ ì¶”ê°€í•´ë³´ì

Herokuì— ë‚´ë¶€ì— ì„œë²„ë¥¼ ë‘˜êº¼ì„

ê·¸ì „ì— build:server ë‘ build:assets ì„ ë¬¶ì–´ ë†“ì

```json
"build": "npm run build:server && npm run build:assets",
```

## 17.3 Deploying to Heroku

ì´ì œ ì„œë²„ë¥¼ Herokuì— ì˜¬ë¦´êº¼ì„

Heroku: https://www.heroku.com/

ê³„ì • ê°€ì…í•˜ê³  create appì—ì„œ ì´ë¦„ ì •í•˜ê³ 

ã„±ã„±

Herokuì— ë°±ì—”ë“œ ì„œë²„ë¥¼ ì—…ë¡œë“œí•˜ëŠ” 2ê°€ì§€ ë°©ë²•ì´ ìˆìŒ

í•˜ë‚˜ëŠ” Githubì´ê³  ë‹¤ë¥¸ í•˜ë‚œ Heroku Git ì„

ì²˜ìŒì—” Heroku Git ì„ í•´ë³¼êº¼ê³ 

ê·¸ë¦¬ê³  Github ì„ í•´ë³¼êº¼ì„

1. Heroku Git

Heroku Gitìœ¼ë¡œ ë°°í¬í•˜ë ¤ë©´ Heroku CLI ë¥¼ ì„¤ì¹˜í•´ì•¼í•¨

(ì„¤ì¹˜? ë°”ë¡œ ê¸°ê° Heroku Gitë¡œ ì—…ë¡œë“œ ì•ˆí• êº¼ì„ ã…‹)

ì»´í„°ì— ì„¤ì¹˜í•˜ê³ 

ì„¤ì¹˜ ì˜ ëëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´

```
$ heroku login
```

í•´ë³´ë˜ powershell ë§ê³  vs ì— ì¹˜ë©´ ë¨

ê¹”ë ¤ ìˆìŒ ì•„ë¬´í‚¤ë‚˜ ëˆ„ë¥´ë¼ëŠ”ë° ì•„ë¬´í‚¤ ì…ë ¥í•˜ë©´

ë¸Œë¼ìš°ì € ì—´ë¦¬ë©´ì„œ ë¡œê·¸ì¸í•˜ë¼ ê·¸ëŸ¼

ë¡œê·¸ì„ í•˜ë©´ë¨

ì´ì œ ë‚´ í”„ë¡œì íŠ¸ë¡œ ì´ë™í•´ì•¼ì§€

```
Create a new Git repository
Initialize a git repository in a new or existing directory

$ cd my-project/
$ git init
$ heroku git:remote -a lugia-wetuberealoed
```

ê·¸ë¦¬ê³ 

```
Deploy your application
Commit your code to the repository and deploy it to Heroku using Git.

$ git add .
$ git commit -am "make it better"
$ git push heroku master
```

ì´ê²Œ gitì—ì„œ add, commit ë“±ë“±ì„ í•˜ê³  push ë¥¼ íˆë¡œì¿ ì—ì„œ í•  ìˆ˜ ìˆë‹¤ëŠ” ì†Œë¦¬ì„

ë‚œ masterê°€ ì•„ë‹ˆë¼ mainìœ¼ë¡œ ë˜ì–´ ìˆë„¤ ì—¼ë³‘?

ì´ë¯¸ í”„ë¡œì íŠ¸ê°€ ìˆìœ¼ë©´

```
Existing Git repository
For existing repositories, simply add the heroku remote

$ heroku git:remote -a lugia-wetube
```

ì°¸ê³ ë¡œ

```
heroku logs --tail
```

í•˜ë©´ íˆë¡œì¿  ë¡œê·¸ë¥¼ ë³¼ìˆ˜ ìˆìŒ

í„°ë¯¸ë„ í•˜ë‚˜ ë” ë§Œë“¤ì–´ì„œ ì €ê±° ì¹˜ë©´ ë¨

ë¡œê·¸ë¥¼ ë³´ë©´

```
Starting process with command `npm start`
```

íˆë¡œì¿ ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ npm startë¥¼ ì‹¤í–‰í•¨

ê·¸ë¦¬ê³ 

```
Error: Cannot init client. Please provide correct options
```

í´ë¼ì´ì–¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ê°€ ì—†ë‹¤ëŠ”ë°

ì´ìœ ëŠ”

```
Assertion failed: You must provide either mongoUrl|clientPromise|client in options
```

DB_URLì´ `.env` íŒŒì¼ì— ìˆì–´ íˆë¡œì¿ ê°€ ì°¾ì§€ ëª»í•œë‹¤ëŠ” ì†Œë¦¬ì„

## 17.4 MongoDB Atlas

ê³„ì •ì„ ë§Œë“¤ê³  ë¬´ë£Œ DBê¹Œì§€ í•˜ë©´

ì´ì œ í´ëŸ¬ìŠ¤í„°ì— connectionì„ ëˆ„ë¥´ë©´ ë¨

Add a connection IP address

ë¼ê³  ìˆëŠ”ë° Allow Access from Anywhere ì´ë¼ê³ 

ëª¨ë‘ì—ê²Œ ê³µê°œí•˜ëŠ”ê±° ëˆ„ë¥´ë©´ ë¨

ê·¸ë¦¬ê³ 

Create a Database User ì—ì„œ DB ê³„ì • ì´ë¦„ì´ë‘ ë¹„ë²ˆì„ ì •í•´ì•¼í•´

ì—¬ê¸°ì„œ ë¹„ë²ˆì€ ë°˜ë“œì‹œ ì•ˆì „í•´ì•¼í•¨

ê·¸ë˜ì„œ ìë™ìƒì„± ã„±ã„±

ìƒˆ íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ê·¸ ë²ˆí˜¸ë¥¼ ì €ì¥í•˜ì

ê·¸ë¦¬ê³  Create Database User ëˆ„ë¦„ ë¨

Choose a connection method, ì—°ê²°ë°©ì‹ ì„ íƒí•˜ê¸° ëˆŒëŸ¬

MongoDB ì˜ native driver ë¥¼ ì‚¬ìš©í•´ì„œ ì•±ê³¼ ì—°ê²° í• êº¼ë‹ˆê¹Œ

connection your application ëˆŒëŸ¬ì¤˜

ëˆ„ë¥´ë©´ ì£¼ì†Œê°€ ë‚˜ì˜¤ëŠ”ë°

```
mongodb+srv://lugiacoders:<password>@cluster0.j16k7at.mongodb.net/?retryWrites=true&w=majority
```

ì´ê²Œ ë°”ë¡œ DB_URL ì„
.env ì— ìˆëŠ” DB_URL ì—­í™œ í•˜ëŠ”ê±°ì„

ì—¬ê¸° password ìë¦¬ì— ì•„ê¹Œ ë°›ì€ ë¹„ë²ˆ ë°•ìŒ ë¨

íˆë¡œì¿ ì— ë³€ìˆ˜ ì„¤ì •ì„ í•˜ë©´ ë˜ëŠ”ë°

ë‚´êº¼ íˆë¡œì¿  ë“¤ê°€ì„œ setting ã„±ã„±

ê±°ê¸°ì„œ Reveal Config Vars ëˆŒëŸ¬ì„œ ë³€ìˆ˜ ì¶”ê°€í•˜ë©´ ë¨

ë³€ìˆ˜ëª… DB_URL ì´ë‘ ê°’ ã„±ã„±

ë¡œê·¸ì°½ ë³´ë©´

```
 Set DB_URL config vars by user ~~
```

ë¼ê³  DB_URLê°’ì´ ì •í•´ì¡Œë‹¤ê³  ë‚˜ì˜´

```
2022-06-02T03:54:35.415796+00:00 app[web.1]: âœ… Server listenting on port http://localhost:4000 ğŸš€
2022-06-02T03:54:37.038302+00:00 app[web.1]: âœ… Connected to DB ğŸ˜
```

ê·¸ë¦¬ê³  ì´ë ‡ê²Œ ì—°ê²°ëë‹¤ê³  ë‚˜ì˜´! ã…‹

ì´ëŸ¬ê³  íˆë¡œì¿ ì— ì˜¤í”ˆ ì•± í•˜ë©´ ì•ˆë¨ ì‘ë‹µì´ ì—†ì–´

ì™œ ì„œë²„ê°€ ì•ˆì—´ë¦´ê¹Œ?

ê·¸ê±´ ì´ë”°ê°€ í•˜ê³  ìš°ì„  .envì— ìˆì–´ì„œ ê°€ì ¸ì˜¬ìˆ˜ ì—†ëŠ” ë³€ìˆ˜ê°’ë“¤ì„

íˆë¡œì¿ ì—ì„œ ì„¤ì •í•´ì£¼ì

COOKIE_SECRET ì€ ë‚´ê°€ ì•„ë¬´ë ‡ê²Œë‚˜ ë§‰ ì¨ì„œ ë°•ìŒ ë¨

## 17.5 Environment Variables

ì§€ê¸ˆ í¬íŠ¸ê°€ 4000ìœ¼ë¡œ ìš°ë¦¬ê°€ ì§€ì •í•œê±° ì“°ê³  ìˆëŠ”ë°

ì´ë ‡ê²Œ í•˜ë©´ íˆë¡œì¿ ê°€ ì§€ì •í•´ì£¼ëŠ” í¬íŠ¸ë¥¼ ëª»ì”€

```js
const PORT = process.env.port || 4000;
```

ì´ë ‡ê²Œ í•´ì£¼ë©´ íˆë¡œì¿ ì—ì„œ ì‹¤í–‰í•˜ë©´ ê·¸ í¬íŠ¸ë¡œ í•˜ê³ 

ë‚´ ì»´í“¨í„°ë¡œ ì‹¤í–‰í•˜ë©´ 4000ìœ¼ë¡œ ì‹¤í–‰ í•´ì¤„êº¼ì„
